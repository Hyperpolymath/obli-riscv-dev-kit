# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 hyperpolymath
#
# Note G / obli-riscv-dev-kit - CI Pipeline

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # SECURITY CHECKS (MANDATORY)
  # ============================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Check for hardcoded secrets
        run: |
          if grep -rEi "(api_key|apikey|secret_key|password|token)\s*[=:]\s*[\"'][A-Za-z0-9+/=]{20,}" \
              --include="*.res" --include="*.scm" --include="*.ts" --include="*.json" . 2>/dev/null \
              | grep -v "example\|sample\|test\|mock\|placeholder"; then
            echo "❌ FAILED: Hardcoded secrets detected"
            exit 1
          fi
          echo "✓ No hardcoded secrets"

      - name: Check HTTPS only
        run: |
          if grep -rE "http://[^l][^o][^c]" \
              --include="*.res" --include="*.scm" --include="*.yaml" --include="*.yml" --include="*.json" . 2>/dev/null \
              | grep -v "localhost\|127.0.0.1\|example\|test\|spec\|schema"; then
            echo "❌ FAILED: HTTP URLs found (use HTTPS)"
            exit 1
          fi
          echo "✓ HTTPS only"

      - name: Check for weak cryptography
        run: |
          if grep -rE "md5\(|sha1\(" \
              --include="*.res" --include="*.ts" --include="*.js" . 2>/dev/null \
              | grep -v "checksum\|cache\|test\|spec"; then
            echo "❌ FAILED: Weak crypto (MD5/SHA1) detected"
            exit 1
          fi
          echo "✓ No weak crypto"

      - name: Verify SHA-pinned actions
        run: |
          if grep -rE "uses:\s+[^@]+@(main|master|latest)$" .github/workflows/*.yml 2>/dev/null \
              | grep -v "#"; then
            echo "❌ FAILED: Unpinned GitHub Actions found"
            exit 1
          fi
          echo "✓ Actions are SHA-pinned"

  # ============================================================================
  # RSR COMPLIANCE
  # ============================================================================
  rsr-compliance:
    name: RSR Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Check required files
        run: |
          MISSING=""
          [ ! -f "guix.scm" ] && MISSING="$MISSING guix.scm"
          [ ! -f "flake.nix" ] && MISSING="$MISSING flake.nix"
          [ ! -f "Containerfile" ] && MISSING="$MISSING Containerfile"
          [ ! -f "LICENSE.txt" ] && MISSING="$MISSING LICENSE.txt"
          [ ! -f ".well-known/security.txt" ] && MISSING="$MISSING security.txt"
          [ ! -f ".editorconfig" ] && MISSING="$MISSING .editorconfig"
          [ ! -f "justfile" ] && MISSING="$MISSING justfile"

          if [ -n "$MISSING" ]; then
            echo "❌ FAILED: Missing required files:$MISSING"
            exit 1
          fi
          echo "✓ All required files present"

      - name: Check SPDX headers
        run: |
          MISSING_SPDX=""
          for f in $(find . -name "*.res" -o -name "*.scm" -o -name "*.ads" -o -name "*.adb" 2>/dev/null | head -30); do
            if ! grep -q "SPDX-License-Identifier" "$f"; then
              MISSING_SPDX="$MISSING_SPDX $f"
            fi
          done

          if [ -n "$MISSING_SPDX" ]; then
            echo "⚠️ WARNING: Files missing SPDX headers:$MISSING_SPDX"
          else
            echo "✓ SPDX headers present"
          fi

      - name: Check SCM files
        run: |
          for f in META.scm STATE.scm ECOSYSTEM.scm PLAYBOOK.scm AGENTIC.scm NEUROSYM.scm; do
            if [ -f "$f" ]; then
              echo "✓ $f present"
            else
              echo "⚠️ $f missing"
            fi
          done

  # ============================================================================
  # ACCESSIBILITY COMPLIANCE
  # ============================================================================
  accessibility:
    name: Accessibility Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Check accessibility configuration
        run: |
          if [ ! -f "a11y/schema.json" ]; then
            echo "❌ FAILED: a11y/schema.json missing"
            exit 1
          fi

          if [ ! -f "noteg.config.json" ]; then
            echo "❌ FAILED: noteg.config.json missing"
            exit 1
          fi

          if ! grep -q '"accessibility"' noteg.config.json; then
            echo "❌ FAILED: No accessibility config in noteg.config.json"
            exit 1
          fi

          echo "✓ Accessibility configuration present"

      - name: Check sign language support
        run: |
          if grep -q '"bsl"\|"asl"\|"gsl"' noteg.config.json 2>/dev/null; then
            echo "✓ Sign language support defined"
          else
            echo "❌ FAILED: No sign language support defined"
            exit 1
          fi

      - name: Validate accessibility schema
        run: |
          # Check JSON validity
          if command -v jq &> /dev/null; then
            jq empty a11y/schema.json && echo "✓ a11y/schema.json is valid JSON"
          else
            echo "⚠️ jq not installed, skipping JSON validation"
          fi

  # ============================================================================
  # LANGUAGE POLICY
  # ============================================================================
  language-policy:
    name: Language Policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Check for forbidden package managers
        run: |
          if find . -name "package-lock.json" -not -path "./.git/*" 2>/dev/null | head -1 | grep .; then
            echo "❌ FAILED: package-lock.json found (use Deno)"
            exit 1
          fi

          if find . -name "bun.lockb" -not -path "./.git/*" 2>/dev/null | head -1 | grep .; then
            echo "❌ FAILED: bun.lockb found (use Deno)"
            exit 1
          fi

          if find . -name "yarn.lock" -not -path "./.git/*" 2>/dev/null | head -1 | grep .; then
            echo "❌ FAILED: yarn.lock found (use Deno)"
            exit 1
          fi

          echo "✓ No forbidden package managers"

      - name: Check Guix/Nix policy
        run: |
          if [ -f "guix.scm" ]; then
            echo "✓ Guix (primary) configured"
          else
            echo "⚠️ guix.scm missing"
          fi

          if [ -f "flake.nix" ]; then
            echo "✓ Nix (fallback) configured"
          else
            echo "⚠️ flake.nix missing"
          fi

  # ============================================================================
  # BUILD & TEST
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [security, rsr-compliance]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: v2.x
        continue-on-error: true

      - name: Install Just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        continue-on-error: true

      - name: Run build
        run: |
          if command -v just &> /dev/null; then
            just build 2>/dev/null || echo "Note: Build not fully configured yet"
          else
            echo "Note: just not available, skipping build"
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Deno
        uses: denoland/setup-deno@5fae568d37c3b73449009674875529a984555dd1 # v2.0.0
        with:
          deno-version: v2.x
        continue-on-error: true

      - name: Run tests
        run: |
          if command -v deno &> /dev/null; then
            deno test tests/ 2>/dev/null || echo "Note: Tests not fully configured yet"
          else
            echo "Note: Deno not available, skipping tests"
          fi

  # ============================================================================
  # DOCUMENTATION
  # ============================================================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Check core documentation
        run: |
          MISSING=""
          [ ! -f "README.adoc" ] && [ ! -f "README.md" ] && MISSING="$MISSING README"
          [ ! -f "LICENSE.txt" ] && [ ! -f "LICENSE" ] && MISSING="$MISSING LICENSE"
          [ ! -f "cookbook.adoc" ] && MISSING="$MISSING cookbook.adoc"

          if [ -n "$MISSING" ]; then
            echo "⚠️ Missing documentation:$MISSING"
          else
            echo "✓ Core documentation present"
          fi

  # ============================================================================
  # FINAL STATUS
  # ============================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [security, rsr-compliance, accessibility, language-policy, build, test, docs]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "❌ Security checks failed"
            exit 1
          fi

          if [ "${{ needs.rsr-compliance.result }}" != "success" ]; then
            echo "❌ RSR compliance failed"
            exit 1
          fi

          if [ "${{ needs.accessibility.result }}" != "success" ]; then
            echo "❌ Accessibility checks failed"
            exit 1
          fi

          echo "✓ All CI checks passed"
